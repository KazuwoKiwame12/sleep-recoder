AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'sleep-recorder

  Sample SAM Template for sleep-recorder

  '
Globals:
  Function:
    Timeout: 5
Resources:
  ApiGatewayApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: ApiGateway-Api
      StageName: Prod
      Auth:
        DefaultAuthorizaer: MyLambdaTokenAuthorizer
        Authorizers:
          MyLambdaTokenAuthorizer:
            FunctionArn:
              Fn::GetAtt:
              - AuthFunction
              - Arn
  AuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: AuthFunction
      Handler: authorizer
      Runtime: go1.x
      Environment:
        Variables:
          CHANNEL_ACCESS_TOKEN: HELLO
  BedinTimeFnction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: BedinTimeFnction
      Handler: bedint-time
      Runtime: go1.x
      Tracing: Active
      Policies: AmazonDynamoDBFullAccess
      Events:
        Save:
          Type: Api
          Properties:
            RestApiId:
              Ref: ApiGatewayApi
            Path: /bedin-time/{user_id}
            Method: POST
      Environment:
        Variables:
          DYNAMODB_ENDPOINT: http://dynamodb:8000
          DYNAMODB_TABLE_NAME: SleepRecord
  SleepRecordDynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
      - AttributeName: Date
        AttributeType: String
      - AttributeName": UserID
        AttributeType: String
      KeySchema:
      - AttributeName: Date
        KeyType: HASH
      - AttributeName: UserID
        KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
      TableName: SleepRecord
Outputs:
  BedinTimeAPI:
    Description: API Gateway endpoint URL for Prod environment for BedinTime Fnction
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/bedin-time/{user_id}
  BedinTimeFnction:
    Description: BedinTimeFnction ARN
    Value:
      Fn::GetAtt:
      - BedinTimeFnction
      - Arn
  BedinTimeFnctionIamRole:
    Description: Implicit IAM Role created for BedinTime Fnction
    Value:
      Fn::GetAtt:
      - BedinTimeFnctionRole
      - Arn
